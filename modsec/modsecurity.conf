# =============================
# Demo-Friendly ModSecurity Config
# =============================

# --- Engine Mode ---
SecRuleEngine DetectionOnly               # log everything (detection mode is fine too)

# --- Request Handling ---
SecRequestBodyAccess On
SecRequestBodyLimit 13107200
SecRequestBodyNoFilesLimit 131072
SecRequestBodyLimitAction ProcessPartial
SecRequestBodyJsonDepthLimit 512
SecArgumentsLimit 1000
SecPcreMatchLimit 100
SecPcreMatchLimitRecursion 100

# --- Response Handling ---
SecResponseBodyAccess On
SecResponseBodyMimeType text/plain text/html text/xml
SecResponseBodyLimit 1048576
SecResponseBodyLimitAction ProcessPartial

# --- Audit Logging ---
SecAuditEngine On                  # log all transactions
SecAuditLog /var/log/modsecurity/audit.log
SecAuditLogFormat JSON
SecAuditLogParts ABIJDEFHZ
SecTmpSaveUploadedFiles On
SecUploadKeepFiles On
SecUploadDir /tmp/modsecurity/upload
SecUploadFileMode 0600

# --- Debug Logging ---
SecDebugLog /var/log/modsecurity/debug.log
SecDebugLogLevel 3

# --- Misc Settings ---
SecArgumentSeparator &
SecCookieFormat 0
SecUnicodeMapFile unicode.mapping 20127
SecStatusEngine Off
SecDisableBackendCompression Off

# --- Request Processor Rules (keep defaults) ---
SecRule REQUEST_HEADERS:Content-Type "^(?:application(?:/soap\+|/)|text/)xml" \
    "id:'1100',phase:1,t:none,t:lowercase,pass,nolog,ctl:requestBodyProcessor=XML"

SecRule REQUEST_HEADERS:Content-Type "^application/json" \
    "id:'1101',phase:1,t:none,t:lowercase,pass,nolog,ctl:requestBodyProcessor=JSON"

SecRule &ARGS "@ge 1000" \
    "id:'1107',phase:2,t:none,log,deny,status:400,msg:'Failed to fully parse request body due to large argument count',severity:2"

SecRule REQBODY_ERROR "!@eq 0" \
    "id:'1102',phase:2,t:none,log,deny,status:400,msg:'Failed to parse request body.',logdata:'%{reqbody_error_msg}',severity:2"

SecRule MULTIPART_STRICT_ERROR "!@eq 0" \
    "id:'1103',phase:2,t:none,log,deny,msg:'Multipart request body failed strict validation'"

SecRule MULTIPART_UNMATCHED_BOUNDARY "@eq 1" \
    "id:'1104',phase:2,t:none,log,deny,msg:'Multipart parser detected a possible unmatched boundary.'"

SecRule TX:/^MSC_/ "!@streq 0" \
    "id:'1105',phase:2,t:none,log,deny,msg:'ModSecurity internal error flagged: %{MATCHED_VAR_NAME}'"

SecRule REQUEST_HEADERS:Content-Type "^application/[a-z0-9.-]+[+]json" \
    "id:'1106',phase:1,t:none,t:lowercase,pass,nolog,ctl:requestBodyProcessor=JSON"

# --- Include CRS rules (if needed) ---
Include /etc/modsecurity.d/custom-rules.conf
