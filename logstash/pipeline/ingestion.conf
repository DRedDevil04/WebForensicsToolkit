input {
  # --- Apache Access Logs ---
  file {
    path => "/var/log/apache2/access.log"
    start_position => "beginning"
    sincedb_path => "/dev/null"
    type => "apache_access"
    tags => ["apache", "access"]
  }

  # --- ModSecurity / WAF Logs ---
  file {
    path => "/var/log/modsec/modsec_audit.log"
    start_position => "beginning"
    sincedb_path => "/dev/null"
    type => "modsec"
    tags => ["waf", "modsecurity"]
  }

  # --- PHP Upload or Forensic Logs ---
  file {
    path => "/var/log/phpapp/upload.log"
    start_position => "beginning"
    sincedb_path => "/dev/null"
    type => "upload_log"
    tags => ["php", "upload"]
  }
}

filter {

  # ---------------- Apache Access ----------------
  if [type] == "apache_access" {
    grok {
      match => {
        "message" => "%{COMBINEDAPACHELOG}"
      }
      remove_field => ["message"]
    }
    mutate {
      add_field => {
        "event.source" => "apache_access"
        "event.module" => "webserver"
      }
      rename => {
        "clientip" => "[client][ip]"
        "verb" => "[http][method]"
        "request" => "[url][original]"
        "response" => "[http][response][status_code]"
        "agent" => "[user_agent][original]"
        "referrer" => "[http][referrer]"
      }
    }
    useragent {
      source => "[user_agent][original]"
      target => "[user_agent]"
    }
    date {
      match => [ "timestamp", "dd/MMM/yyyy:HH:mm:ss Z" ]
      remove_field => ["timestamp"]
    }
  }

  # ---------------- ModSecurity / WAF ----------------
  if [type] == "modsec" {
    grok {
      match => {
        "message" => "\[%{TIMESTAMP_ISO8601:timestamp}\] \[%{IP:client.ip}\] \[%{WORD:method}\] %{URIPATHPARAM:url.original} (?:.*id \"%{NUMBER:rule_id}\")?(?:.*msg \"%{DATA:waf_message}\")?"
      }
      tag_on_failure => ["_modsec_grok_fail"]
    }
    mutate {
      add_field => {
        "event.source" => "modsecurity"
        "event.module" => "waf"
        "event.category" => "web"
      }
    }
    date {
      match => [ "timestamp", "ISO8601" ]
      remove_field => ["timestamp"]
    }
  }

  # ---------------- PHP Upload / Forensic ----------------
  if [type] == "upload_log" {
    # Example: [2025-11-12T21:01:23Z] [edce9617eb639339] Upload from 172.19.0.1 - filename=test.php size=128KB status=success
    grok {
      match => {
        "message" => "\[%{TIMESTAMP_ISO8601:timestamp}\] \[%{DATA:session_id}\] Upload from %{IP:client.ip} - filename=%{DATA:file.name} size=%{DATA:file.size} status=%{WORD:upload.status}"
      }
      tag_on_failure => ["_upload_grok_fail"]
    }
    mutate {
      add_field => {
        "event.source" => "php_upload"
        "event.module" => "application"
        "event.action" => "file_upload"
      }
    }
    date {
      match => [ "timestamp", "ISO8601" ]
      remove_field => ["timestamp"]
    }
  }

  # ---------------- Common Normalization ----------------
  mutate {
    add_field => { "ingested_at" => "%{@timestamp}" }
  }

  # Clean nulls, whitespace, etc.
  mutate {
    strip => ["message"]
    remove_field => ["host", "path", "type"]
  }
}

output {
  elasticsearch {
    hosts => ["http://elasticsearch:9200"]
    index => "forensic-logs-%{+YYYY.MM.dd}"
    ilm_enabled => false
  }

  stdout {
    codec => rubydebug
  }
}
